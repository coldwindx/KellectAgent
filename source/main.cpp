#pragma once
#include <curl/curl.h>
#include "process/event.h"
#include "initialization/initializer.h"
#include "process/etw_config.h"
#include "tools/json.hpp"

//int main(int argc, char* argv[]) {
//	std::string s = "{ \"happy\": true, \"pi\": 3.141 }";
//	auto j = nlohmann::json::parse(s.c_str());
//	return 0;
//}

//int main(int argc, char* argv[]) {
//	ElasticOutPut* op = new ElasticOutPut("10.101.169.215:9200");
//	op->init();
//	std::string s = "{\"Event\":\"RegistryQueryValue\",\"PID\":4332,\"PName\":\"DSAService.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":11060,\"TimeStamp\":133493248779576584,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Index\":2,\"InitialTime\":158033110,\"KeyHandle\":1047049024,\"KeyName\":\"AutoDownload\",\"Status\":3221225524}}\n{\"Event\":\"RegistrySetInformation\",\"PID\":4332,\"PName\":\"DSAService.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":11060,\"TimeStamp\":133493248779576432,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Index\":0,\"InitialTime\":158032999,\"KeyHandle\":1047049024,\"KeyName\":\"\",\"Status\":0}}\n{\"Event\":\"RegistryOpen\",\"PID\":4332,\"PName\":\"DSAService.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":11060,\"TimeStamp\":133493248779576410,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Index\":0,\"InitialTime\":158032822,\"KeyHandle\":780963184,\"KeyName\":\"Software\\Intel\\Driver and Support Assistant\\Settings\",\"Status\":0}}\n{\"Event\":\"TcpIpReconnectIPV4\",\"PID\":10768,\"PName\":\"RadeonSoftware.exe\",\"PPID\":7212,\"PPName\":\"unknown\",\"TID\":-1,\"TimeStamp\":133493248779734708,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"PID\":10768,\"connid\":0,\"daddr\":\"127.0.0.1\",\"dport\":60178,\"saddr\":\"127.0.0.1\",\"seqnum\":0,\"size\":0,\"sport\":34264}}\n{\"Event\":\"ThreadStart\",\"PID\":16476,\"PName\":\"ServiceHub.IndexingService.exe\",\"PPID\":15068,\"PPName\":\"Microsoft.ServiceHub.Controller.exe\",\"TID\":5612,\"TimeStamp\":133493248779576284,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Affinity\":63,\"BasePriority\":6,\"IoPriority\":2,\"PagePriority\":5,\"ProcessId\":16476,\"StackBase\":3788144640,\"StackLimit\":3788115968,\"SubProcessTag\":0,\"TThreadId\":5612,\"TebBase\":2224529408,\"ThreadFlags\":0,\"UserStackBase\":2226913280,\"UserStackLimit\":2226909184,\"Win32StartAddr\":902905392}}\n{\"Event\":\"ThreadEnd\",\"PID\":8760,\"PName\":\"devenv.exe\",\"PPID\":16972,\"PPName\":\"explorer.exe\",\"TID\":9456,\"TimeStamp\":133493248779740684,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Affinity\":63,\"BasePriority\":8,\"IoPriority\":2,\"PagePriority\":5,\"ProcessId\":8760,\"StackBase\":3830054912,\"StackLimit\":3830026240,\"SubProcessTag\":0,\"TThreadId\":9456,\"TebBase\":2736857088,\"ThreadFlags\":0,\"UserStackBase\":2801795072,\"UserStackLimit\":2801741824,\"Win32StartAddr\":3446954080}}\n{\"Event\":\"ThreadStart\",\"PID\":7784,\"PName\":\"ServiceHub.TestWindowStoreHost.exe\",\"PPID\":15068,\"PPName\":\"Microsoft.ServiceHub.Controller.exe\",\"TID\":17996,\"TimeStamp\":133493248780195648,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Affinity\":63,\"BasePriority\":8,\"IoPriority\":2,\"PagePriority\":5,\"ProcessId\":7784,\"StackBase\":3830054912,\"StackLimit\":3830026240,\"SubProcessTag\":0,\"TThreadId\":17996,\"TebBase\":1671913472,\"ThreadFlags\":0,\"UserStackBase\":1674838016,\"UserStackLimit\":1674833920,\"Win32StartAddr\":3445619088}}\n{\"Event\":\"FileIOCreate\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781953655,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"CreateOptions\":18874368,\"FileAttributes\":0,\"FileObject\":2793420736,\"IrpPtr\":2555810040,\"OpenPath\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"ShareAccess\":7,\"TTID\":9064}}\n{\"Event\":\"FileIOCleanup\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781954279,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"FileObject\":2793420736,\"IrpPtr\":2555810040,\"TTID\":9064}}\n{\"Event\":\"FileIOClose\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781954372,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"FileObject\":2793420736,\"IrpPtr\":2555810040,\"TTID\":9064}}\n{\"Event\":\"FileIOCreate\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781954590,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"CreateOptions\":16777312,\"FileAttributes\":0,\"FileObject\":2793425936,\"IrpPtr\":2555810040,\"OpenPath\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"ShareAccess\":5,\"TTID\":9064}}\n{\"Event\":\"ImageLoad\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781955519,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"DefaultBase\":3655335936,\"FileName\":\"C:\\Windows\\System32\\wevtapi.dll\",\"ImageBase\":3655335936,\"ImageChecksum\":445241,\"ImageSize\":413696,\"ProcessId\":1280,\"Reserved0\":0,\"Reserved1\":0,\"Reserved2\":0,\"Reserved3\":0,\"Reserved4\":0,\"SignatureLevel\":0,\"SignatureType\":0,\"TimeDateStamp\":2253929557}}\n{\"Event\":\"FileIOCreate\",\"PID\":4632,\"PName\":\"MsMpEng.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":5708,\"TimeStamp\":133493248781957468,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"CreateOptions\":18956352,\"FileAttributes\":0,\"FileObject\":2793420736,\"IrpPtr\":2555810040,\"OpenPath\":\"C:\\Windows\\System32\\wevtapi.dll\",\"ShareAccess\":7,\"TTID\":5708}}\n{\"Event\":\"FileIOCleanup\",\"PID\":4632,\"PName\":\"MsMpEng.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":5708,\"TimeStamp\":133493248781958683,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\System32\\wevtapi.dll\",\"FileObject\":2793420736,\"IrpPtr\":2540839160,\"TTID\":5708}}\n{\"Event\":\"FileIOClose\",\"PID\":4632,\"PName\":\"MsMpEng.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":5708,\"TimeStamp\":133493248781958782,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\System32\\wevtapi.dll\",\"FileObject\":2793420736,\"IrpPtr\":2540839160,\"TTID\":5708}}\n{\"Event\":\"FileIOCleanup\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781959491,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"FileObject\":2793425936,\"IrpPtr\":2540839160,\"TTID\":9064}}\n{\"Event\":\"FileIOClose\",\"PID\":1280,\"PName\":\"msedgewebview2.exe\",\"PPID\":7540,\"PPName\":\"WebViewHost.exe\",\"TID\":9064,\"TimeStamp\":133493248781959588,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\SYSTEM32\\wevtapi.dll\",\"FileObject\":2793425936,\"IrpPtr\":2540839160,\"TTID\":9064}}\n{\"Event\":\"FileIOCreate\",\"PID\":4632,\"PName\":\"MsMpEng.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":5708,\"TimeStamp\":133493248781961181,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"CreateOptions\":21119008,\"FileAttributes\":0,\"FileObject\":2793425936,\"IrpPtr\":2540839160,\"OpenPath\":\"C:\\Windows\\System32\\wevtapi.dll\",\"ShareAccess\":7,\"TTID\":5708}}\n{\"Event\":\"FileIOCleanup\",\"PID\":4632,\"PName\":\"MsMpEng.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":5708,\"TimeStamp\":133493248781961961,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"FileKey\":871500288,\"FileName\":\"C:\\Windows\\System32\\wevtapi.dll\",\"FileObject\":2793425936,\"IrpPtr\":2540839160,\"TTID\":5708}}\n{\"Event\":\"RegistryQuery\",\"PID\":4332,\"PName\":\"DSAService.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":11060,\"TimeStamp\":133493248779576237,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Index\":7,\"InitialTime\":158032798,\"KeyHandle\":780963184,\"KeyName\":\"\",\"Status\":0}}\n{\"Event\":\"RegistryClose\",\"PID\":4332,\"PName\":\"DSAService.exe\",\"PPID\":468,\"PPName\":\"services.exe\",\"TID\":11060,\"TimeStamp\":133493248779576662,\"Host-UUID\":\"E6FCBA22-F86A-4377-87EF-7DBDD74DE472\",\"args\":{\"Index\":0,\"InitialTime\":158033237,\"KeyHandle\":1047049024,\"KeyName\":\"\",\"Status\":0}}\n\n";
//	op->output(s);
//}
//
int main(int argc, char* argv[]) {

    ULONG64 enabledFlags;
	Initializer init(argc, argv);

	enabledFlags = init.init();

	//EventPerfInfo::initSystemCallMap();
	ETWConfiguration etwConfiguration (enabledFlags);

	etwConfiguration.ETWSessionConfig(true);	//thread task
	etwConfiguration.mainSessionConfig(true);
	//etwConfiguration.showAllProviders();
}
